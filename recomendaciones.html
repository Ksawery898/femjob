<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FemJob | Recomendaciones</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="topbar">
  <div class="nav">
    <a class="brand" href="index.html">
      <div class="logo"></div>
      <span>FemJob</span>
    </a>

    <nav class="navlinks">
      <a href="index.html">Inicio</a>
      <a class="active" href="recomendaciones.html">Recomendaciones</a>
      <a href="perfil.html">Mi Perfil</a>
      <a href="capacitacion.html">Capacitación</a>
      <a href="empresa.html">Empresas</a>
      <a href="sobre.html">Sobre</a>
      <a href="contacto.html">Contacto</a>
      <a href="faq.html">FAQ</a>
      <a href="terminos.html">Términos</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="card">
    <span class="badge">Recomendaciones (MVP útil)</span>
    <h1>Vacantes adaptadas a tu perfil</h1>
    <p id="introText">
      FemJob puntúa y ordena vacantes según tu perfil (área, modalidad, experiencia y habilidades).
    </p>
    <div id="profileChip" class="care-chip" style="display:none;"></div>
  </section>

  <div class="grid">

    <aside class="card">
      <h2>Opciones</h2>

      <div class="field" style="margin-bottom:0;">
        <label style="display:flex; gap:10px; align-items:center;">
          <input id="careOnly" type="checkbox" />
          Mostrar solo empleos compatibles con cuidados
        </label>
      </div>

      <p class="hint" style="margin-top:8px;">
        *Disponible si activaste el modo cuidadora en tu perfil.
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="btn secondary" type="button" onclick="rerank()">Actualizar recomendaciones</button>
        <button class="btn" type="button" onclick="location.href='perfil.html'">Editar perfil</button>
      </div>

      <hr>

      <p class="meta" id="statsText">Cargando recomendaciones…</p>
    </aside>

    <section class="card">
      <h2>Top recomendaciones</h2>
      <p class="meta" style="margin-bottom:10px;">
        Arrastra (móvil/PC) o usa botones. Se muestra compatibilidad calculada.
      </p>

      <div class="swipe-wrap" id="swipeWrap"></div>

      <div class="swipe-actions">
        <button class="btn bad" type="button" onclick="swipe('left')">Descartar</button>
        <button class="btn ok" type="button" onclick="swipe('right')">Guardar</button>
        <button class="btn primary" type="button" onclick="alert('Postulación simulada')">Postular</button>
      </div>

      <p class="hint" style="margin-top:12px;">
        *MVP: la compatibilidad se calcula localmente. No hay backend.
      </p>
    </section>

  </div>

  <div class="footer">FemJob • Recomendaciones (MVP)</div>
</main>

<script>
  const KEY_PROFILE = "femjob_profile_mvp_v1";

  // ===== Dataset de vacantes (demo) =====
  const JOBS = [
    { id: 1, title:"Analista de Marketing (Part-time)", company:"Empresa Naranja", city:"Santiago", area:"Marketing", modality:"Remoto", exp:"Junior",
      skills:["excel","marketing","comunicacion","crm"], careCompatible:true, tags:["Remoto","Flexible","Part-time"], summary:"Apoyo en campañas y reportes. Jornada reducida." },
    { id: 2, title:"Asistente Administrativo", company:"Grupo Andes", city:"Santiago", area:"Administración", modality:"Híbrido", exp:"Junior",
      skills:["excel","gestion","comunicacion"], careCompatible:true, tags:["Híbrido","Horario definido","Beneficios"], summary:"Documentación, coordinación y apoyo administrativo." },
    { id: 3, title:"Analista de Datos (SQL)", company:"DataLab", city:"Santiago", area:"TI / Datos", modality:"Híbrido", exp:"Semi-senior",
      skills:["sql","data","excel"], careCompatible:true, tags:["SQL","Híbrido","Datos"], summary:"Reportería, consultas SQL y análisis de KPIs." },
    { id: 4, title:"Asistente RR.HH.", company:"PeopleCo", city:"Santiago", area:"RR.HH.", modality:"Presencial", exp:"Junior",
      skills:["rrhh","comunicacion","gestion"], careCompatible:false, tags:["Presencial","Onboarding","Selección"], summary:"Apoyo en selección y administración de personal." },
    { id: 5, title:"Soporte al Cliente", company:"ServicioPlus", city:"Santiago", area:"Servicios", modality:"Remoto", exp:"Junior",
      skills:["atencion","comunicacion"], careCompatible:true, tags:["Remoto","Clientes","Turnos"], summary:"Atención al cliente, seguimiento y resolución de casos." },
    { id: 6, title:"Desarrolladora Junior (Python)", company:"TechNova", city:"Santiago", area:"TI / Datos", modality:"Remoto", exp:"Junior",
      skills:["python","sql","data"], careCompatible:true, tags:["Python","Remoto","Junior"], summary:"Desarrollo de scripts, automatización y apoyo en data." },
  ];

  // ===== Helpers =====
  function getProfile(){
    const raw = localStorage.getItem(KEY_PROFILE);
    return raw ? JSON.parse(raw) : null;
  }

  function overlapCount(a, b){
    const setB = new Set(b);
    return a.filter(x => setB.has(x)).length;
  }

  // ===== Scoring (compatibilidad real) =====
  function scoreJob(job, profile){
    // Pesos simples para MVP (fácil de explicar en informe)
    const W_AREA = 35;
    const W_MODALITY = 20;
    const W_EXP = 15;
    const W_SKILLS = 25;
    const W_CARE = 5;

    let score = 0;

    if(profile.area === job.area) score += W_AREA;
    if(profile.modalidad === job.modality) score += W_MODALITY;

    // experiencia: match exacto suma; si job pide menos o igual, suma parcial
    if(profile.experiencia === job.exp) score += W_EXP;
    else {
      const order = { "Junior": 1, "Semi-senior": 2, "Senior": 3 };
      if(order[profile.experiencia] > order[job.exp]) score += Math.round(W_EXP * 0.6);
      else score += Math.round(W_EXP * 0.2);
    }

    const skillsMatch = overlapCount(profile.skills || [], job.skills || []);
    const skillsMax = Math.max(1, (job.skills || []).length);
    score += Math.round((skillsMatch / skillsMax) * W_SKILLS);

    if(profile.careMode && job.careCompatible) score += W_CARE;
    if(profile.careMode && !job.careCompatible) score -= 3;

    // clamp
    score = Math.max(0, Math.min(100, score));
    return score;
  }

  function renderCard(job, pct){
    const careBadge = job.careCompatible ? `<div class="care-badge">Compatible con cuidados</div>` : ``;

    const tagsHtml = (job.tags || []).map(t => `<span class="tag">${t}</span>`).join("");

    return `
      <div class="swipe-card" data-id="${job.id}" data-care="${job.careCompatible ? "true":"false"}">
        ${careBadge}
        <h2 style="margin:0 0 6px;">${job.title}</h2>
        <div class="meta">${job.company} • ${job.city} • ${job.modality}</div>
        <div class="tags">${tagsHtml}</div>
        <hr>
        <p><b>Resumen:</b> ${job.summary}</p>
        <span class="pill">${pct}% compatibilidad</span>
      </div>
    `;
  }

  // ===== Build recommendations =====
  function buildRecommendations(){
    const profile = getProfile();
    const wrap = document.getElementById("swipeWrap");

    if(!profile){
      document.getElementById("introText").textContent =
        "No encontramos tu perfil. Ve a “Mi Perfil” para crearlo y recibir recomendaciones personalizadas.";
      document.getElementById("statsText").textContent = "Sin perfil guardado.";
      wrap.innerHTML = `
        <div class="card" style="background:#f8fafc;">
          <h3 style="margin:0 0 8px;">Aún no tienes perfil</h3>
          <p style="margin:0 0 12px;">Crea tu perfil para ver vacantes adaptadas a tus preferencias y habilidades.</p>
          <button class="btn primary" onclick="location.href='perfil.html'">Crear perfil</button>
        </div>
      `;
      return;
    }

    // Chip resumen
    const chip = document.getElementById("profileChip");
    chip.style.display = "inline-flex";
    chip.textContent = `Perfil: ${profile.area} • ${profile.modalidad} • ${profile.experiencia}`;

    // Care filter enabled?
    const careOnly = document.getElementById("careOnly");
    careOnly.disabled = !profile.careMode;
    if(!profile.careMode) careOnly.checked = false;

    // Scoring + sorting
    let scored = JOBS.map(j => ({ job: j, score: scoreJob(j, profile) }))
      .sort((a,b) => b.score - a.score);

    // Optionally filter care-compatible
    if(profile.careMode && careOnly.checked){
      scored = scored.filter(x => x.job.careCompatible);
    }

    // Render top N as swipe stack
    const topN = scored.slice(0, 6);
    wrap.innerHTML = topN.map(x => renderCard(x.job, x.score)).join("");

    document.getElementById("statsText").textContent =
      `Mostrando ${topN.length} recomendaciones ordenadas por compatibilidad.`;

    // activar drag en la primera
    attachDragToTopCard();
  }

  function rerank(){
    buildRecommendations();
    alert("Recomendaciones actualizadas (demo).");
  }

  // ===== Swipe actions (rotate cards) =====
  function swipe(direction){
    const wrap = document.getElementById("swipeWrap");
    const card = wrap.querySelector(".swipe-card");
    if(!card) return;

    card.classList.add(direction === "left" ? "is-left" : "is-right");

    setTimeout(() => {
      card.classList.remove("is-left","is-right");
      card.style.transform = "";
      wrap.appendChild(card);
      attachDragToTopCard();
    }, 260);
  }

  // ===== Swipe drag touch + mouse =====
  const THRESHOLD = 90;

  function attachDragToTopCard(){
    const wrap = document.getElementById("swipeWrap");
    const top = wrap.querySelector(".swipe-card");
    if(!top) return;

    // prevent duplicate listeners
    if(top.dataset.dragReady === "1") return;
    top.dataset.dragReady = "1";

    let startX=0, startY=0, dx=0, dy=0, dragging=false;

    function onStart(x,y){
      dragging=true; startX=x; startY=y; dx=0; dy=0;
      top.style.transition="none";
    }
    function onMove(x,y){
      if(!dragging) return;
      dx=x-startX; dy=y-startY;
      const rot = Math.max(-10, Math.min(10, dx/12));
      top.style.transform = `translate(${dx}px, ${dy*0.25}px) rotate(${rot}deg)`;
    }
    function onEnd(){
      if(!dragging) return;
      dragging=false;
      top.style.transition="transform .22s ease, opacity .22s ease";

      if(dx > THRESHOLD){
        top.classList.add("is-right");
        setTimeout(()=>{ top.classList.remove("is-right"); top.style.transform=""; wrap.appendChild(top); attachDragToTopCard(); }, 240);
      } else if(dx < -THRESHOLD){
        top.classList.add("is-left");
        setTimeout(()=>{ top.classList.remove("is-left"); top.style.transform=""; wrap.appendChild(top); attachDragToTopCard(); }, 240);
      } else {
        top.style.transform="";
      }
    }

    // touch
    top.addEventListener("touchstart", e => { const t=e.touches[0]; onStart(t.clientX, t.clientY); }, {passive:true});
    top.addEventListener("touchmove", e => { const t=e.touches[0]; onMove(t.clientX, t.clientY); }, {passive:true});
    top.addEventListener("touchend", () => onEnd(), {passive:true});

    // mouse
    top.addEventListener("mousedown", e => {
      onStart(e.clientX, e.clientY);
      const mm = ev => onMove(ev.clientX, ev.clientY);
      const mu = () => { document.removeEventListener("mousemove", mm); document.removeEventListener("mouseup", mu); onEnd(); };
      document.addEventListener("mousemove", mm);
      document.addEventListener("mouseup", mu);
    });
  }

  // Care-only checkbox listener
  document.getElementById("careOnly").addEventListener("change", buildRecommendations);

  window.addEventListener("load", buildRecommendations);
</script>

</body>
</html>
