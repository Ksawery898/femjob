<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FemJob | Recomendaciones</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="topbar">
  <div class="nav">
    <a class="brand" href="index.html">
      <div class="logo"></div>
      <span>FemJob</span>
    </a>

    <nav class="navlinks">
      <a href="index.html">Inicio</a>
      <a class="active" href="recomendaciones.html">Recomendaciones</a>
      <a href="guardadas.html">Guardadas</a>
      <a href="perfil.html">Mi Perfil</a>
      <a href="capacitacion.html">Capacitación</a>
      <a href="empresa.html">Empresas</a>
      <a href="sobre.html">Sobre</a>
      <a href="contacto.html">Contacto</a>
      <a href="faq.html">FAQ</a>
      <a href="terminos.html">Términos</a>
    </nav>
  </div>
</header>

<main class="container">

  <!-- CONTENEDOR PERSONA -->
  <div id="personaView" style="display:none;">
    <section class="card">
      <span class="badge">Recomendaciones (Persona)</span>
      <h1>Vacantes adaptadas a tu perfil</h1>
      <p id="introText">Cargando…</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <div id="profileChip" class="care-chip" style="display:none;"></div>
        <div id="savedChip" class="care-chip" style="display:none;"></div>
      </div>
    </section>

    <div class="grid">
      <aside class="card">
        <h2>Opciones</h2>

        <div class="field" style="margin-bottom:0 remember;">
          <label style="display:flex; gap:10px; align-items:center;">
            <input id="careOnly" type="checkbox" />
            Mostrar solo empleos compatibles con cuidados
          </label>
        </div>

        <p class="hint" style="margin-top:8px;">
          *Disponible si activaste el modo cuidadora.
        </p>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn secondary" type="button" onclick="build()">Actualizar</button>
          <button class="btn" type="button" onclick="location.href='perfil.html'">Editar perfil</button>
          <button class="btn primary" type="button" onclick="location.href='guardadas.html'">Ver guardadas</button>
        </div>

        <hr>
        <p class="meta" id="statsText">…</p>
        <p class="hint">Tip: Guardar ✅ agrega la vacante a “Guardadas”.</p>
      </aside>

      <section class="card">
        <h2>Top recomendaciones</h2>
        <p class="meta" style="margin-bottom:10px;">Arrastra o usa botones. “Guardar” guarda de verdad.</p>

        <div class="swipe-wrap" id="swipeWrap"></div>

        <div class="swipe-actions">
          <button class="btn bad" type="button" onclick="swipe('left')">Descartar</button>
          <button class="btn ok" type="button" onclick="swipe('right')">Guardar</button>
          <button class="btn primary" type="button" onclick="applyNow()">Postular</button>
        </div>

        <p class="hint" style="margin-top:12px;">
          *MVP: se guarda en localStorage (no backend). Ideal para demo universitaria.
        </p>
      </section>
    </div>
  </div>

  <!-- CONTENEDOR EMPRESA -->
  <div id="empresaView" style="display:none;">
    <section class="card">
      <span class="badge">Cuenta Empresa</span>
      <h1>Esta sección es para personas</h1>
      <p>
        Estás usando FemJob como <b>Empresa</b>. Aquí no se muestran recomendaciones de vacantes.
        Ve a tu panel para publicar ofertas y revisar postulaciones (demo).
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="btn primary" onclick="location.href='empresa.html'">Ir a panel empresa</button>
        <button class="btn secondary" onclick="location.href='perfil.html'">Cambiar rol</button>
      </div>
    </section>
  </div>

  <div class="footer">FemJob • Interacción por roles</div>
</main>

<script>
  // ===== Claves =====
  const KEY_USER = "femjob_user_v1";
  const KEY_SAVED = "femjob_saved_jobs_v1";

  // ===== Guard: si no hay perfil, ir a perfil =====
  const rawUser = localStorage.getItem(KEY_USER);
  if(!rawUser){
    location.href = "perfil.html";
  }
  const user = rawUser ? JSON.parse(rawUser) : null;

  // ===== Vista según rol =====
  const personaView = document.getElementById("personaView");
  const empresaView = document.getElementById("empresaView");

  if(user && user.rol === "empresa"){
    empresaView.style.display = "block";
  } else {
    personaView.style.display = "block";
  }

  // ===== Dataset de vacantes (demo) =====
  const JOBS = [
    { id: 1, title:"Analista de Marketing (Part-time)", company:"Empresa Naranja", city:"Santiago", area:"Marketing", modality:"Remoto", exp:"Junior",
      skills:["excel","marketing","comunicacion","crm"], careCompatible:true, tags:["Remoto","Flexible","Part-time"], summary:"Apoyo en campañas y reportes. Jornada reducida." },
    { id: 2, title:"Asistente Administrativo", company:"Grupo Andes", city:"Santiago", area:"Administración", modality:"Híbrido", exp:"Junior",
      skills:["excel","gestion","comunicacion"], careCompatible:true, tags:["Híbrido","Horario definido","Beneficios"], summary:"Documentación, coordinación y apoyo administrativo." },
    { id: 3, title:"Analista de Datos (SQL)", company:"DataLab", city:"Santiago", area:"TI / Datos", modality:"Híbrido", exp:"Semi-senior",
      skills:["sql","data","excel"], careCompatible:true, tags:["SQL","Híbrido","Datos"], summary:"Reportería, consultas SQL y análisis de KPIs." },
    { id: 4, title:"Asistente RR.HH.", company:"PeopleCo", city:"Santiago", area:"RR.HH.", modality:"Presencial", exp:"Junior",
      skills:["rrhh","comunicacion","gestion"], careCompatible:false, tags:["Presencial","Onboarding","Selección"], summary:"Apoyo en selección y administración." },
    { id: 5, title:"Soporte al Cliente", company:"ServicioPlus", city:"Santiago", area:"Servicios", modality:"Remoto", exp:"Junior",
      skills:["atencion","comunicacion"], careCompatible:true, tags:["Remoto","Clientes","Turnos"], summary:"Atención al cliente y seguimiento." },
    { id: 6, title:"Desarrolladora Junior (Python)", company:"TechNova", city:"Santiago", area:"TI / Datos", modality:"Remoto", exp:"Junior",
      skills:["python","sql","data"], careCompatible:true, tags:["Python","Remoto","Junior"], summary:"Automatización y apoyo en data." },
  ];

  // ===== Saved jobs helpers =====
  function getSaved(){
    const raw = localStorage.getItem(KEY_SAVED);
    return raw ? JSON.parse(raw) : []; // array de IDs
  }
  function setSaved(ids){
    localStorage.setItem(KEY_SAVED, JSON.stringify(ids));
  }
  function isSaved(id){
    return getSaved().includes(id);
  }
  function addSaved(id){
    const ids = getSaved();
    if(!ids.includes(id)) ids.push(id);
    setSaved(ids);
    updateSavedChip();
  }
  function removeSaved(id){
    const ids = getSaved().filter(x => x !== id);
    setSaved(ids);
    updateSavedChip();
  }
  function updateSavedChip(){
    const chip = document.getElementById("savedChip");
    const n = getSaved().length;
    chip.style.display = "inline-flex";
    chip.textContent = `Guardadas: ${n}`;
  }

  // ===== Scoring =====
  function overlapCount(a, b){
    const setB = new Set(b);
    return a.filter(x => setB.has(x)).length;
  }

  function scoreJob(job, profile){
    const W_AREA = 35, W_MODALITY = 20, W_EXP = 15, W_SKILLS = 25, W_CARE = 5;
    let score = 0;

    if(profile.area === job.area) score += W_AREA;
    if(profile.modalidad === job.modality) score += W_MODALITY;

    const order = { "Junior": 1, "Semi-senior": 2, "Senior": 3 };
    if(profile.experiencia === job.exp) score += W_EXP;
    else if(order[profile.experiencia] > order[job.exp]) score += Math.round(W_EXP * 0.6);
    else score += Math.round(W_EXP * 0.2);

    const skillsMatch = overlapCount(profile.skills || [], job.skills || []);
    const skillsMax = Math.max(1, (job.skills || []).length);
    score += Math.round((skillsMatch / skillsMax) * W_SKILLS);

    if(profile.careMode && job.careCompatible) score += W_CARE;
    if(profile.careMode && !job.careCompatible) score -= 3;

    return Math.max(0, Math.min(100, score));
  }

  function renderCard(job, pct){
    const careBadge = job.careCompatible ? `<div class="care-badge">Compatible con cuidados</div>` : ``;
    const tagsHtml = (job.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
    const savedState = isSaved(job.id);

    return `
      <div class="swipe-card" data-id="${job.id}">
        ${careBadge}
        <h2 style="margin:0 0 6px;">${job.title}</h2>
        <div class="meta">${job.company} • ${job.city} • ${job.modality}</div>
        <div class="tags">${tagsHtml}</div>
        <hr>
        <p><b>Resumen:</b> ${job.summary}</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <span class="pill">${pct}% compatibilidad</span>
          <span class="tag">${savedState ? "⭐ En guardadas" : "Aún no guardada"}</span>
        </div>
      </div>
    `;
  }

  function build(){
    if(!user || user.rol === "empresa") return;

    document.getElementById("introText").textContent =
      `FemJob ordena vacantes según tu perfil: ${user.area} • ${user.modalidad} • ${user.experiencia}.`;

    const chip = document.getElementById("profileChip");
    chip.style.display = "inline-flex";
    chip.textContent = `Perfil: ${user.area} • ${user.modalidad} • ${user.experiencia}`;

    updateSavedChip();

    const careOnly = document.getElementById("careOnly");
    careOnly.disabled = !user.careMode;
    if(!user.careMode) careOnly.checked = false;

    let scored = JOBS
      .map(j => ({ job: j, score: scoreJob(j, user) }))
      .sort((a,b) => b.score - a.score);

    if(user.careMode && careOnly.checked){
      scored = scored.filter(x => x.job.careCompatible);
    }

    const top = scored.slice(0, 6);
    document.getElementById("swipeWrap").innerHTML = top.map(x => renderCard(x.job, x.score)).join("");
    document.getElementById("statsText").textContent = `Mostrando ${top.length} vacantes ordenadas por compatibilidad.`;

    attachDragToTopCard();
  }

  // ===== Acciones =====
  function getTopCard(){
    const wrap = document.getElementById("swipeWrap");
    return wrap.querySelector(".swipe-card");
  }

  function getJobById(id){
    return JOBS.find(j => j.id === id);
  }

  function applyNow(){
    const card = getTopCard();
    if(!card) return;
    const id = Number(card.dataset.id);
    const job = getJobById(id);
    if(!job) return;

    alert(`Postulación simulada ✅\n\nVacante: ${job.title}\nEmpresa: ${job.company}`);
  }

  function swipe(direction){
    const wrap = document.getElementById("swipeWrap");
    const card = getTopCard();
    if(!card) return;

    const id = Number(card.dataset.id);

    if(direction === "right"){
      addSaved(id); // ✅ guardar real
      showToast("Guardado en Guardadas ✅");
    } else {
      showToast("Descartado ❌");
    }

    card.classList.add(direction === "left" ? "is-left" : "is-right");
    setTimeout(() => {
      card.classList.remove("is-left","is-right");
      card.style.transform = "";
      wrap.appendChild(card);
      build(); // re-render para actualizar estado "⭐ En guardadas"
    }, 260);
  }

  // ===== Toast simple =====
  function showToast(text){
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id = "toast";
      t.style.position = "fixed";
      t.style.left = "50%";
      t.style.bottom = "18px";
      t.style.transform = "translateX(-50%)";
      t.style.padding = "10px 14px";
      t.style.borderRadius = "999px";
      t.style.border = "1px solid rgba(0,0,0,0.10)";
      t.style.background = "#fff";
      t.style.boxShadow = "0 10px 24px rgba(0,0,0,0.12)";
      t.style.fontWeight = "800";
      t.style.fontSize = "13px";
      t.style.zIndex = "9999";
      document.body.appendChild(t);
    }
    t.textContent = text;
    t.style.opacity = "1";
    clearTimeout(window.__toastTO);
    window.__toastTO = setTimeout(() => { t.style.opacity = "0"; }, 1400);
  }

  // ===== Swipe drag =====
  const THRESHOLD = 90;
  function attachDragToTopCard(){
    const wrap = document.getElementById("swipeWrap");
    const top = wrap.querySelector(".swipe-card");
    if(!top) return;
    if(top.dataset.dragReady === "1") return;
    top.dataset.dragReady = "1";

    let startX=0, startY=0, dx=0, dy=0, dragging=false;

    function onStart(x,y){ dragging=true; startX=x; startY=y; dx=0; dy=0; top.style.transition="none"; }
    function onMove(x,y){
      if(!dragging) return;
      dx=x-startX; dy=y-startY;
      const rot = Math.max(-10, Math.min(10, dx/12));
      top.style.transform = `translate(${dx}px, ${dy*0.25}px) rotate(${rot}deg)`;
    }
    function onEnd(){
      if(!dragging) return;
      dragging=false;
      top.style.transition="transform .22s ease, opacity .22s ease";

      if(dx > THRESHOLD){
        swipe("right");
      } else if(dx < -THRESHOLD){
        swipe("left");
      } else {
        top.style.transform="";
      }
    }

    top.addEventListener("touchstart", e => { const t=e.touches[0]; onStart(t.clientX, t.clientY); }, {passive:true});
    top.addEventListener("touchmove", e => { const t=e.touches[0]; onMove(t.clientX, t.clientY); }, {passive:true});
    top.addEventListener("touchend", () => onEnd(), {passive:true});

    top.addEventListener("mousedown", e => {
      onStart(e.clientX, e.clientY);
      const mm = ev => onMove(ev.clientX, ev.clientY);
      const mu = () => { document.removeEventListener("mousemove", mm); document.removeEventListener("mouseup", mu); onEnd(); };
      document.addEventListener("mousemove", mm);
      document.addEventListener("mouseup", mu);
    });
  }

  document.getElementById("careOnly")?.addEventListener("change", build);
  window.addEventListener("load", build);
</script>

</body>
</html>
